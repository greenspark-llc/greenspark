<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Schedule Your Service | GreenSpark</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --safe-top: env(safe-area-inset-top); }
    .tooltip:hover .tooltip-text { opacity: 1; visibility: visible; transform: translateY(0); }
  </style>
</head>
<body class="bg-white font-sans overflow-x-hidden">
  <!-- ===== Fixed Header (Responsive) with Services ===== -->
<header class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur border-b">
  <div class="w-full px-3 sm:px-4 lg:px-5 [padding-left:env(safe-area-inset-left)] [padding-right:env(safe-area-inset-right)]">
    <div class="h-14 md:h-16 flex items-center justify-between overflow-x-clip" style="padding-top: var(--safe-top)">

      <!-- Brand -->
      <a href="/" class="text-2xl md:text-3xl font-semibold text-green-600 hover:opacity-90 transition">
        Green<span class="text-green-500">Spark</span>
      </a>

      <!-- Desktop Nav -->
      <nav class="hidden md:flex items-center gap-2 text-base">
        <a href="tel:1-310-528-6134" class="text-green-600 font-medium px-2">1-310-528-6134</a>

        <!-- Services (desktop dropdown) -->
        <div class="relative group">
          <button
            class="inline-flex items-center gap-1 px-3 py-2 rounded-xl hover:bg-gray-50 text-gray-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-green-500"
            aria-haspopup="true" aria-expanded="false">
            Services
            <svg class="h-4 w-4 text-gray-500 group-hover:rotate-180 transition-transform" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.08 1.04l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
            </svg>
          </button>
          <div
            class="invisible opacity-0 translate-y-2 group-hover:visible group-hover:opacity-100 group-hover:translate-y-0 focus-within:visible focus-within:opacity-100 focus-within:translate-y-0 transition-all
                   absolute left-0 mt-2 w-72 rounded-2xl border bg-white shadow-lg p-2">
            <a href="turf.html" class="block px-3 py-2 rounded-xl hover:bg-gray-50 text-gray-800">Turf</a>
            <a href="/services/landscape-design" class="block px-3 py-2 rounded-xl hover:bg-gray-50 text-gray-800">Landscape Design</a>
            <a href="/services/sprinkler-installation" class="block px-3 py-2 rounded-xl hover:bg-gray-50 text-gray-800">Sprinkler Installation</a>
            <a href="/services/seasonal-services" class="block px-3 py-2 rounded-xl hover:bg-gray-50 text-gray-800">Seasonal Services</a>
            <a href="/services/sod-seeding" class="block px-3 py-2 rounded-xl hover:bg-gray-50 text-gray-800">Sod &amp; Seeding</a>
            <a href="/services/lawn-maintenance" class="block px-3 py-2 rounded-xl hover:bg-gray-50 text-gray-800">Lawn Maintenance</a>
          </div>
        </div>

        <!-- Original buttons/links preserved -->
        <a href="sign_in.html" class="px-4 py-2 border border-green-600 rounded-full text-green-600 hover:bg-green-50">Sign In</a>
        <a href="/GetPricing.html" class="bg-green-400 hover:bg-green-600 text-black px-4 py-2 rounded-full">Get Your Price</a>
        <a href="commercial.html" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full">Commercial Services</a>
        <a href="contact.html" class="px-4 py-2 bg-black rounded-full text-white hover:bg-green-400">Contact Us</a>
      </nav>

      <!-- Mobile Menu Button -->
      <button id="menuBtn" class="md:hidden inline-flex items-center justify-center p-2 rounded-lg border border-green-600 text-green-700">
        <span class="sr-only">Open menu</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-width="2" d="M4 7h16M4 12h16M4 17h16"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile Drawer -->
  <div id="mobileNav" class="md:hidden hidden border-t bg-white">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col gap-3">

      <!-- Services (mobile accordion) -->
      <div class="border rounded-xl">
        <button
          class="w-full flex items-center justify-between px-3 py-3 text-left rounded-xl"
          data-accordion-trigger aria-expanded="false">
          <span class="text-gray-900 font-medium">Services</span>
          <svg class="h-5 w-5 text-gray-500 transition-transform" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.08 1.04l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
          </svg>
        </button>
        <div class="hidden pb-2" data-accordion-panel>
          <a href="turf.html" class="block px-4 py-2 rounded-lg hover:bg-gray-50">Turf</a>
          <a href="/services/landscape-design" class="block px-4 py-2 rounded-lg hover:bg-gray-50">Landscape Design</a>
          <a href="/services/sprinkler-installation" class="block px-4 py-2 rounded-lg hover:bg-gray-50">Sprinkler Installation</a>
          <a href="/services/seasonal-services" class="block px-4 py-2 rounded-lg hover:bg-gray-50">Seasonal Services</a>
          <a href="/services/sod-seeding" class="block px-4 py-2 rounded-lg hover:bg-gray-50">Sod &amp; Seeding</a>
          <a href="/services/lawn-maintenance" class="block px-4 py-2 rounded-lg hover:bg-gray-50">Lawn Maintenance</a>
        </div>
      </div>

      <!-- Original mobile links -->
      <a href="tel:1-310-528-6134" class="text-green-700 font-medium">1-310-528-6134</a>
      <a href="sign_in.html" class="px-4 py-2 border border-green-600 rounded-full text-green-700 text-center">Sign In</a>
      <a href="/GetPricing.html" class="bg-green-400 hover:bg-green-500 text-black px-4 py-2 rounded-full text-center">Get Your Price</a>
      <a href="commercial.html" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-center">Commercial Services</a>
      <a href="contact.html" class="px-4 py-2 bg-black rounded-full text-white hover:bg-green-400 text-center">Contact Us</a>
    </div>
  </div>
</header>


  <!-- Push content below fixed header -->
  <div class="pt-[3.5rem] md:pt-16"></div>

  <main class="px-4 md:px-8 py-10">
    <div class="max-w-7xl mx-auto">
      <!-- Progress / Back -->
      <div class="mb-6 flex items-center justify-between">
        <a id="backToPackages" href="quote.html" class="inline-flex items-center gap-2 text-green-700 hover:underline">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Back to Packages
        </a>
        <p class="text-sm text-gray-500">Step 2 of 2 — Schedule & Confirm</p>
      </div>

      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl md:text-4xl font-semibold text-gray-900">Schedule Your Visit</h1>
        <p class="text-gray-600 mt-2">Pick a date & time window, confirm your details, and lock in your quote.</p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left: Form -->
        <section class="lg:col-span-2">
          <form id="scheduleForm"
                action="https://formspree.io/f/mdklpqpn"
                method="POST"
                class="bg-white rounded-2xl border p-6 space-y-6">
            <!-- Formspree meta -->
            <input type="hidden" name="_subject" value="New scheduling request – GreenSpark">
            <input type="text"   name="_gotcha"  class="hidden" tabindex="-1" autocomplete="off">
            <!-- _next becomes absolute on submit -->
            <input type="hidden" name="_next" value="thank-you.html">

            <!-- Selection snapshot (filled by JS) -->
            <input type="hidden" name="selected_package">
            <input type="hidden" name="selected_frequency">
            <input type="hidden" name="selected_tier">
            <input type="hidden" name="selection_json">

            <!-- Quote numbers (filled by JS) -->
            <input type="hidden" name="base_price">
            <input type="hidden" name="addons_per_visit">
            <input type="hidden" name="first_visit_fee" value="10">
            <input type="hidden" name="first_visit_estimate">
            <input type="hidden" name="monthly_estimate">

            <!-- Package Summary (compact on mobile) -->
            <div class="bg-green-50 rounded-xl p-4">
              <p class="text-sm text-gray-600">Selected:</p>
              <div class="mt-1 flex flex-wrap items-center gap-x-4 gap-y-1">
                <span id="summaryPackage" class="font-semibold text-green-700">—</span>
                <span id="summaryFrequency" class="text-sm text-gray-700">—</span>
                <span class="text-gray-300">•</span>
                <span id="summaryTier" class="text-sm text-gray-700">—</span>
              </div>
            </div>

            <!-- Contact -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm mb-1">Full Name</label>
                <input required name="name" class="w-full border rounded-lg px-3 py-2" placeholder="First & Last Name" />
              </div>
              <div>
                <label class="block text-sm mb-1">Phone</label>
                <input required name="phone" type="tel" class="w-full border rounded-lg px-3 py-2" placeholder="(555) 123-4567" />
              </div>
              <div>
                <label class="block text-sm mb-1">Email</label>
                <input required name="email" type="email" class="w-full border rounded-lg px-3 py-2" placeholder="you@example.com" />
              </div>
              <div>
                <label class="block text-sm mb-1">ZIP</label>
                <input id="zipInput" name="zip" class="w-full border rounded-lg px-3 py-2" placeholder="90210" />
              </div>
            </div>

            <!-- Address -->
            <div>
              <label class="block text-sm mb-1">Service Address</label>
              <input required name="address" class="w-full border rounded-lg px-3 py-2" placeholder="Street, City, State" />
            </div>

            <!-- Date & Time -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm mb-1">Preferred Date</label>
                <input required id="dateInput" name="date" type="date" class="w-full border rounded-lg px-3 py-2" />
                <p class="text-xs text-gray-500 mt-1">Mon–Sat availability</p>
              </div>
              <div>
                <label class="block text-sm mb-1">Time Window</label>
                <select required id="timeWindow" name="timeWindow" class="w-full border rounded-lg px-3 py-2">
                  <option value="">Select…</option>
                  <option value="8–10am">8–10am</option>
                  <option value="10am–12pm">10am–12pm</option>
                  <option value="12–2pm">12–2pm</option>
                  <option value="2–4pm">2–4pm</option>
                  <option value="4–6pm">4–6pm</option>
                </select>
              </div>
            </div>

            <!-- Extras (optional) -->
            <div>
              <label class="block text-sm mb-2">Optional Add-Ons</label>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <label class="flex items-center gap-3 border rounded-lg p-3">
                  <input type="checkbox" class="accent-green-600" name="addons" value="petWaste" />
                  <span class="text-sm">Pet waste pickup (+$8/visit)</span>
                </label>
                <label class="flex items-center gap-3 border rounded-lg p-3">
                  <input type="checkbox" class="accent-green-600" name="addons" value="bagHaul" />
                  <span class="text-sm">Green-waste haul (+$12/visit)</span>
                </label>
              </div>
            </div>

            <div>
              <label class="block text-sm mb-1">Notes for Your Crew (optional)</label>
              <textarea name="notes" class="w-full border rounded-lg px-3 py-2" rows="3" placeholder="Gate code, pets, parking, special requests…"></textarea>
            </div>

            <!-- Submit -->
            <button class="w-full bg-green-400 hover:bg-green-500 text-black rounded-full py-3 font-medium">
              Request My Visit & Quote
            </button>

            <!-- (Note: with _next set, this message won't be seen after submit) -->
            <p id="successMsg" class="hidden text-green-700 bg-green-50 border border-green-200 rounded-xl p-4 text-sm">
              Thanks! We’ve received your request. A confirmation will be sent to your email and phone shortly.
            </p>
          </form>
        </section>

        <!-- Right: Quote Summary -->
        <aside class="bg-white rounded-2xl border p-6 h-fit sticky top-24">
          <h2 class="text-xl font-semibold text-gray-900">Your Quote</h2>
          <p class="text-sm text-gray-500 mt-1">Auto-updates as you choose options.</p>

          <div class="mt-4 space-y-2 text-sm">
            <div class="flex justify-between">
              <span>Package</span><span id="qPackage" class="font-medium">—</span>
            </div>
            <div class="flex justify-between">
              <span>Frequency</span><span id="qFrequency" class="font-medium">—</span>
            </div>
            <div class="flex justify-between">
              <span>Base price / visit</span><span id="qBase" class="font-medium">—</span>
            </div>
            <div class="flex justify-between">
              <span>Add-ons / visit</span><span id="qAddons" class="font-medium">$0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500">First-visit service fee</span><span id="qFirstFee" class="text-gray-500">$10</span>
            </div>
            <hr class="my-2">
            <div class="flex justify-between text-base">
              <span class="font-semibold">Estimated first visit</span>
              <span id="qFirstVisit" class="font-semibold">$—</span>
            </div>
            <div class="flex justify-between">
              <span>Monthly estimate</span>
              <span id="qMonthly" class="font-medium">$—</span>
            </div>
            <p class="text-xs text-gray-500 mt-2">Monthly estimate assumes 4.3× for weekly or 2.15× for biweekly.</p>
          </div>

          <div class="mt-6 bg-green-50 border border-green-200 rounded-xl p-4">
            <p class="text-sm text-green-800">
              All-electric. Quiet. Fume-free. Licensed, bonded & insured.
            </p>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <script>
    // Mobile nav toggle
    document.getElementById("menuBtn")?.addEventListener("click", () => {
      document.getElementById("mobileNav").classList.toggle("hidden");
    });

    // ---------------------------
    // State hydration & utilities
    // ---------------------------
    const pkgMap = {
      "eco-essentials": "Eco-Essentials",
      "eco-care": "Eco-Care",
      "eco-supreme": "Eco-Supreme"
    };
    const monthlyFactor = (freq) => (freq === "weekly" ? 4.3 : 2.15);
    const ADDON_PRICES = { petWaste: 8, bagHaul: 12 };
    const FIRST_VISIT_FEE = 10;

    const qs = new URLSearchParams(location.search);
    const qsZip = qs.get("zip");
    const qsPkg = qs.get("pkg");
    const qsFreq = qs.get("freq");
    const qsTier = qs.get("tier");
    const qsBase = qs.get("base");

    // Pull selection from localStorage (if any)
    let sel = {};
    try { sel = JSON.parse(localStorage.getItem("greenspark_selection") || "{}"); } catch (_) {}

    // Merge URL params into selection (fallback when navigating directly or via links)
    if (qsPkg) sel.package = qsPkg;
    if (qsFreq) sel.frequency = qsFreq;
    if (qsTier) sel.tier = qsTier;
    if (qsBase && !isNaN(Number(qsBase))) sel.basePrice = Number(qsBase);

    // Persist merged selection back (so all pages stay in sync)
    localStorage.setItem("greenspark_selection", JSON.stringify(sel));

    // Guard: must have at least a package + base price to quote meaningfully
    if (!sel || !sel.package || !sel.basePrice) {
      // If we truly can't compute, kick back to GetPricing to re-select with ZIP context
      location.href = "/GetPricing.html";
    }

    // ZIP hydration precedence: query > localStorage > selection payload
    const storedZip = localStorage.getItem("greenspark_zip");
    const zipInput = document.getElementById("zipInput");
    const resolvedZip = qsZip || storedZip || sel.zip || "";
    if (zipInput && resolvedZip) {
      zipInput.value = resolvedZip;
      localStorage.setItem("greenspark_zip", resolvedZip);
      sel.zip = resolvedZip;
      localStorage.setItem("greenspark_selection", JSON.stringify(sel));
    }
    // Keep ZIP sticky if user edits here
    zipInput?.addEventListener("input", (e) => {
      const z = (e.target.value || "").trim();
      localStorage.setItem("greenspark_zip", z);
      sel.zip = z;
      localStorage.setItem("greenspark_selection", JSON.stringify(sel));
    });

    // Back to Packages — preserve state
    document.getElementById("backToPackages")?.addEventListener("click", (e) => {
      e.preventDefault();
      const cameFromQuote = document.referrer && /quote\.html/i.test(document.referrer);
      if (cameFromQuote) {
        history.back();
        return;
      }
      // Fallback: rebuild a stateful link to quote.html
      const params = new URLSearchParams({
        zip: sel.zip || "",
        pkg: sel.package || "",
        freq: sel.frequency || "",
        tier: sel.tier || "",
        base: String(sel.basePrice || "")
      });
      location.href = `quote.html?${params.toString()}`;
    });

    // Summary labels
    const pkgLabel = pkgMap[sel.package] || sel.package || "—";
    document.getElementById("summaryPackage").textContent = pkgLabel;
    document.getElementById("summaryFrequency").textContent =
      (sel.frequency || "—").replace(/^./, c => c.toUpperCase());
    document.getElementById("summaryTier").textContent =
      sel.tier ? `${sel.tier.charAt(0).toUpperCase() + sel.tier.slice(1)} tier` : "Standard";

    // Quote box initial fill
    document.getElementById("qPackage").textContent = pkgLabel;
    document.getElementById("qFrequency").textContent =
      (sel.frequency || "—").replace(/^./, c => c.toUpperCase());
    document.getElementById("qBase").textContent =
      sel.basePrice ? `$${Number(sel.basePrice).toFixed(0)}` : "—";
    document.getElementById("qFirstFee").textContent = `$${FIRST_VISIT_FEE}`;

    // Date constraints: min today+1, max 60 days; block Sundays
    const dateInput = document.getElementById("dateInput");
    const tzOffsetMs = new Date().getTimezoneOffset() * 60 * 1000;
    const todayLocal = new Date(Date.now() - tzOffsetMs);
    const min = new Date(todayLocal); min.setDate(min.getDate() + 1);
    const max = new Date(todayLocal); max.setDate(max.getDate() + 60);
    dateInput.min = min.toISOString().slice(0,10);
    dateInput.max = max.toISOString().slice(0,10);
    dateInput.addEventListener("change", (e) => {
      const d = new Date(e.target.value + "T00:00:00");
      if (d.getDay() === 0) {
        alert("We’re closed on Sundays. Please pick Monday–Saturday.");
        e.target.value = "";
      }
    });

    function calcAddonsTotal() {
      const boxes = Array.from(document.querySelectorAll('input[name="addons"]:checked'));
      const total = boxes.reduce((sum, b) => sum + (ADDON_PRICES[b.value] || 0), 0);
      const el = document.getElementById("qAddons");
      if (el) el.textContent = `$${total}`;
      return total;
    }

    // Fill hidden inputs for Formspree before submit (and whenever quote changes)
    function updateHiddenFields() {
      const base = Number(sel.basePrice || 0);
      const addOns = calcAddonsTotal();
      const firstVisit = base + addOns + FIRST_VISIT_FEE;
      const monthly = (base + addOns) * monthlyFactor(sel.frequency || "weekly");

      const setVal = (name, val) => {
        const input = document.querySelector(`input[name="${name}"]`);
        if (input) input.value = String(val ?? "");
      };

      // Selection snapshot
      setVal("selected_package", pkgLabel);
      setVal("selected_frequency", (sel.frequency || "").replace(/^./, c => c.toUpperCase()));
      setVal("selected_tier", sel.tier ? sel.tier.charAt(0).toUpperCase() + sel.tier.slice(1) : "Standard");
      setVal("selection_json", JSON.stringify(sel));

      // Quote numbers
      setVal("base_price", base.toFixed(0));
      setVal("addons_per_visit", addOns.toFixed(0));
      setVal("first_visit_fee", FIRST_VISIT_FEE.toFixed(0));
      setVal("first_visit_estimate", firstVisit.toFixed(0));
      setVal("monthly_estimate", monthly.toFixed(0));
    }

    // Recalculate quote UI + sync hidden fields
    function refreshQuote() {
      const base = Number(sel.basePrice || 0);
      const addOns = calcAddonsTotal();
      const firstVisit = base + addOns + FIRST_VISIT_FEE;
      const monthly = (base + addOns) * monthlyFactor(sel.frequency || "weekly");

      document.getElementById("qFirstVisit").textContent = `$${firstVisit.toFixed(0)}`;
      document.getElementById("qMonthly").textContent = `$${monthly.toFixed(0)}`;

      updateHiddenFields();
    }

    // Add-on change listeners
    document.querySelectorAll('input[name="addons"]').forEach(i => {
      i.addEventListener("change", refreshQuote);
    });

    // Initial quote + hidden fields
    refreshQuote();

    // Submit: make _next absolute, sync hidden, then let browser POST normally
    document.getElementById("scheduleForm").addEventListener("submit", () => {
      const nextInput = document.querySelector('input[name="_next"]');
      if (nextInput) nextInput.value = `${location.origin}/thank-you.html`;
      updateHiddenFields();
      // No preventDefault -> Formspree handles and redirects to absolute thank-you
    });
  </script>

  <script>
    // Hamburger → drawer toggle
    (function () {
      const btn = document.getElementById('menuBtn');
      const nav = document.getElementById('mobileNav');
      if (!btn || !nav) return;

      btn.addEventListener('click', () => {
        nav.classList.toggle('hidden');
        document.body.classList.toggle('overflow-hidden'); // prevent scroll when open (optional)
      });

      // Close when a link is tapped (optional)
      nav.querySelectorAll('a').forEach(a =>
        a.addEventListener('click', () => {
          nav.classList.add('hidden');
          document.body.classList.remove('overflow-hidden');
        })
      );
    })();
  </script>

<script>
  // Services accordion in mobile drawer
  (function () {
    const triggers = document.querySelectorAll('[data-accordion-trigger]');
    triggers.forEach((t) => {
      const panel = t.parentElement.querySelector('[data-accordion-panel]');
      const icon = t.querySelector('svg');
      t.addEventListener('click', () => {
        const open = !panel.classList.contains('hidden');
        panel.classList.toggle('hidden', open);
        icon.style.transform = open ? '' : 'rotate(180deg)';
        t.setAttribute('aria-expanded', String(!open));
      });
    });
  })();
</script>

</body>
</html>
